<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Grapevine | .NET Embeddable Rest Server</title>

		<meta name="description" content="Grapevine is an embeddable REST server written is C# for the .NET platform, based on the HttpListener class. It also contains a powerful yet easy to use REST client.">
		<meta name="author" content="Scott Offen">

		<!-- missing favicon -->

		<link rel="stylesheet" href="/Grapevine/assets/css/bootstrap.min.css">
		<link rel="stylesheet" href="/Grapevine/assets/css/ie10-viewport-bug-workaround.css">
		<link rel="stylesheet" href="/Grapevine/assets/css/prism.min.css">
		<link rel="stylesheet" href="/Grapevine/assets/css/font-awesome.min.css">
		<link rel="stylesheet" href="/Grapevine/assets/css/styles.css">

		<!--
	 	<link rel="apple-touch-icon" href="/Grapevine/assets/img/apple-touch-icon.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/Grapevine/assets/img/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/Grapevine/assets/img/apple-touch-icon-114x114.png">
		-->

		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>
		<nav class="navbar navbar-default navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="/Grapevine/">Grapevine</a>
				</div>
				<div id="navbar" class="navbar-collapse collapse">
					<div class="navbar-form navbar-left" role="search">
						<div class="form-group">
							<input id="search" type="search" class="form-control" placeholder="Search">
						</div>
					</div>
					<ul class="nav navbar-nav navbar-right">
						<!--
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li><a href="/Grapevine/rest_client">Rest Client</a></li>
								<li><a href="/Grapevine/rest_server">Rest Server</a></li>
								<li><a href="/Grapevine/misc">Miscellaneous</a></li>
								<li><a href="/Grapevine/about">About Grapevine</a></li>
							</ul>
						</li>
						-->
						<li><a href="https://github.com/sukona/Grapevine" class="text-muted pull-right"><i class="fa fa-github"></i> Fork on GitHub</a></li>
						<li><a href="https://gitter.im/sukona/Grapevine?utm_source=share-link&utm_medium=link&utm_campaign=share-link">Discuss on Gitter</a></li>
					</ul>
				</div>
			</div>
		</nav>

		<!--
		<div class="container">
			<div class="row">
				<div class="col-lg-12 text-center">
				<h2>Embedding A Rest Server In Your Application Should Be Simple</h2>
				<p class="lead">
					<a href="https://travis-ci.org/sukona/Grapevine"><img src="https://travis-ci.org/sukona/Grapevine.svg?branch=master"/></a>
					<a href="https://www.nuget.org/packages/Grapevine/"><img src="https://img.shields.io/nuget/v/Grapevine.svg"></img></a>
					<a href="https://www.nuget.org/packages/Grapevine/4.0.0-alpha0"><img src="https://img.shields.io/nuget/vpre/Grapevine.svg?label=alpha"/></a>
					<a href="https://gitter.im/sukona/Grapevine"><img src="https://img.shields.io/gitter/room/sukona/Grapevine.svg"/></a>
				</p>
				</div>
			</div>

			<div class="row">
				<div class="col-sm-5 col-sm-offset-1 col-md-4 col-md-offset-1">
					<h3>Rest Server</h3>
					<p>Grapevine allows you to easily embed a rest server in your .NET application. Built using HttpListener, Grapevine provides mechanisms for serving up both static files and dynamic resources. Map class methods and generic delegates to HTTP Methods and URL patterns (supports regular expressions, too).</p>
					<p><a class="btn btn-default" href="/Grapevine/rest_server" role="button">Learn More &raquo;</a></p>
				</div>

				<div class="col-sm-5 col-md-4 col-md-offset-2">
					<h3>Rest Client</h3>
					<p>Grapevine allows you to easily consume rest services in your .NET application. Built using HttpWebRequest and HttpWebResponse, Grapevine exposes simple pattern placeholders to send requests and parse responses. Use reusable objects to represent remote resources and parse responses.</p>
					<p><a class="btn btn-default" href="/Grapevine/rest_client" role="button">Learn More &raquo;</a></p>
				</div>
			</div>
		</div>
		-->

		<div class="container">
			<div class="row">
				<h1>Grapevine</h1>
				<p>Grapevine is both a REST server <b>and</b> a REST client. At this point, the majority interest in Grapevine tends to revolve around the server capabilities. Hence, this initial draft of the documentation will focus on the implementation and usage of <code>RestServer</code>.</p>
				<p>Grapevine is intentionally unopinionated and simple. We don't want to get in your way or force you to do things the way we think they should be done. If we're failing at that and you have any suggestions on how we could improve this, we encourage you to submit an issue on Github.</p>
				<p>The <code>RestServer</code> contains methods to configure and start an <a href="https://msdn.microsoft.com/en-us/library/system.net.httplistener%28v=vs.110%29.aspx?f=255&MSPPError=-2147217396" target="_blank"><code>HttpListener</code></a> instance. It listens on the specified protocol/host/port combination and drops all incoming http requests into a queue. The server then has number of worker threads that constantly monitor the queue, pull out the <code>HttpListenerContext</code> instance, wraps it in an <code>HttpContext</code> instance and and routes it to the matching <code>Route</code> instances in the servers internal <code>Router</code>.</p>
			</div>

			<!-- Dynamic Properties -->
			<div class="row">
				<h2 id="dynamics">Working With Dynamic Properties</h2>
				<hr/>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>Using IDynamicProperties</h3>
					<p>One of the first things to be aware of is the ability to extend an object via dynamic properties. Currently, both <code>IRestServer</code> and <code>IHttpContext</code> require you to implement the <code>IDynamicProperties</code> interface. It is recommended that everything that requires this interface implement it via the <code>DynamicProperties</code> abstract class.</p>
					<p>Creating a dynamic property is then only a matter of creating some extension methods around the larger interface. The convinience methods <code>ContainsProperty(string key)</code> and <code>GetPropertyValueAs&lt;T&gt;(string key)</code> are already provided via extensions on the <code>IDynamicProperty</code> interface. The example code here shows adding a property called <code>Database</code> to the <code>IRestServer</code> interface.<p>
					<p>Dynamic properties are useful for sharing custom application context with the code inside your routes without needing to extend any classes.</p>
					<div class="well well-sm">Note that you will always want to add the properties to the interface, not the concrete class, as everything internally is referenced by interface.</div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
							public class Database { /* this can be anything you want */ }

							public static class ServerDatabaseExtensionMethods
							{
								private static string DbKey = "Database";

								public static void SetDatabase(this IRestServer server, Database db)
								{
									server.Properties[DbKey] = db;
								}

								public static Database GetDatabase(this IRestServer server)
								{
									if (server.ContainsProperty(DbKey))
									{
										return server.GetPropertyValueAs&lt;Database&gt;(DbKey);
									}

									// You could throw an error instead
									return null;
								}
							}

							// And now you can get and set the dynamic property
							var server = new RestServer();
							server.SetDatabase(new Database());
							var database = server.GetDatabase();
						</code>
					</pre>
				</div>
			</div>

			<!-- HttpContext -->
			<div class="row">
				<h2 id="httpcontext">Working With The Http Context</h2>
				<hr/>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>HttpContext</h3>
					<p>Grapevine wraps the <code>HttpListenerContext</code> inside an internal <code>HttpContext</code> object. This object implements the <code>IHttpContext</code> interface. The provided implementation, <code>HttpContext</code>, has an internal constructor and therefore can only be instantiated by the <code>RestServer</code>. In addition to providing the same properites (or equvilant versions) as <code>HttpListenerContext</code>, the interface also provides a reference back to the server that is handling the request via the <code>Server</code> property and <code>WasRespondedTo</code>, a boolean property indicating whether or not the route has sent a response to the client.</p>
					<div class="well well-sm">The method signature of all methods and generic delegates used by routes must accept an <code>IHttpContext</code> as the single parameter and return an <code>IHttpContext</code>.</div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
							// Provides modified access to the request and response objects used by the
							// HttpListener class
							public interface IHttpContext : IDynamicProperties
							{
								// Gets the IHttpRequest that represents a client's request for a resource
								IHttpRequest Request { get; }

								// Gets the IHttpResponse object that will be sent to the client in response
								// to the client's request
								IHttpResponse Response { get; }

								// Gets an object used to obtain identity, authentication information, and security
								// roles for the client whose request is represented by the underlying
								// HttpListenerContext object
								IPrincipal User { get; }

								// Gets the IRestServer object the client request was sent to
								IRestServer Server { get; }

								// Returns a value that indicate whether or not the client request has been responded to
								bool WasRespondedTo { get; }
							}
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3 id="httprequests">HttpRequest</h3>
					<p><code>HttpRequest</code> implements <code>IHttpRequest</code> which - with a few notable exceptions - exposes the same set of properties as <a href="https://msdn.microsoft.com/en-us/library/system.net.httplistenerrequest(v=vs.100).aspx" target="_blank"><code>HttpListenerRequest</code></a>.
					<div class="well well-sm">The <code>Advanced</code> property on the request provides direct access to the input stream of the request via the <code>InputStream</code> property.</div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
							// Instead of a string, returns the corresponding Grapevine.Util.ContentType
							request.ContentType;

							// Instead of a string, returns the corresponding Grapevine.Util.HttpMethod
							request.HttpMethod;

							// Grapevine gives each request its own unique GUID for easy correleation of events
							request.Id;

							// Grapevine provides a name that is a concatonation of the HttpMethod and the
							// PathInfo properties
							request.Name;

							// PathInfo is the part of the URL that preceedes the ? in the RawUrl property and is
							// used to determine route matching
							request.PathInfo;

							// If a route is using a pattern with placeholders (not a  of regular expression) the
							// values matched are stored in this read-only dictionary
							// For example, if the route patterns is /api/user/[id] and the PathInfo property
							// is /api/user/1234, then the line below will return '1234'
							request.PathParameters["id"];

							// Payload returns a string representation of the contents of the body
							// To access the request stream directly, use the Advanced property
							request.Payload;
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>HttpResponse</h3>
					<p><code>HttpResponse</code> implements <code>IHttpResponse</code> which - again, with a few notable exceptions - exposes the same set of properties as <a href="https://msdn.microsoft.com/en-us/library/system.net.httplistenerresponse(v=vs.100).aspx" target="_blank"><code>HttpListenerResponse</code></a>.
					<p>Here, in addition to some convinience properties, there are the <code>SendResponse()</code> convinience methods, to simplify the process of responding to the client. Most of the parameters can be set independent of the <code>SendResponse()</code> methods.</p>
					<div class="well well-sm">The <code>Advanced</code> property on the response provides direct access to the request output stream via <code>OutputStream</code> as well as access to the <code>Close()</code> methods you can find on <code>HttpListenerResponse</code>.</div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
							// Instead of a string, accepts/returns the corresponding Grapevine.Util.ContentType
							response.ContentType;

							// The ContentEncoding property defaults to Encoding.ASCII
							response.ContentEncoding;

							// Returns true if HttpListenerResponse.Close() gets called, which happens
							// automatically when any of the SendResponse() methods are called.
							response.ResponseSent;

							// Instead of a number, accepts/returns the corresponding Grapevine.Util.HttpStatusCode
							response.StatusCode = HttpStatusCode.Ok; // 200

							// SendResponse() has multiple overloads, intended to simplify how you send a response
							// to the client; in all cases, the response output stream and the response get closed
							// and the ResponseSent property is set to true.

							// If you pass a string of text, that text will be sent to the client
							response.SendResponse("Hello, world!");

							// If you pass a file path as a string and a true value, the file will be returned to
							// the client
							response.SendResponse(@"c:\data\somefile.xls", true);

							// If you pass a string and an encoding type, the encoding type will be used to
							// return the text to the client
							response.SendResponse("Hello, world!", Encoding.UTF8);

							// If you pass a FileStream and a ContentType, the file will be sent to the client
							// and the Content-type header will be set to the ContentType provided
							response.SendResponse(file_stream, ContentType.XLSX, "myfile.xlsx")

							// If you do the same as above, but also pass a true value, the the file will be
							// downloaded by the browser instead of loaded in the browser
							response.SendResponse(file_stream, ContentType.XLSX, "myfile.xlsx", true);

							// If you pass a status code and an exception, the exception will be returned to the
							// client using the status code provided
							response.SendResponse(HttpStatusCode.InternalServerError, new Exception("Bad stuff"));

							// If you pass a status code and some text, the text will be returned to the client
							// using the status code provided
							response.SendResponse(HttpStatusCode.ImATeapot, "Kind of a real status code.");

							// If you pass just the status code, the text of the status code will be sent to the
							// client
							response.SendResponse(HttpStatusCode.EnhanceYourCalm);
							// the body will contain the text "Enhance Your Calm"
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>NameValueCollection Extensions</h3>
					<p>The <code>Headers</code> and <code>QueryString</code> properties of <code>HttpRequest</code> are of type <code>NameValueCollection</code>, and Grapevine provides two extension methods for convinience in working with them.</p>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
							// Automatically casts the value of the specified header to generic type parameter
							request.Headers.GetValue&lt;int&gt;("key");

							// Automatically casts the value of the specified header to generic type parameter
							// or returns the specified default value if the header is not found
							request.Headers.GetValue&lt;int&gt;("key", 32);
						</code>
					</pre>
				</div>
			</p>

			<!-- RestServer -->
			<div class="row">
				<h2>The REST Server</h2>
				<hr/>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>RestServer</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>ServerSettings</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>PublicFolder</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>RestCluster</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>

			<!-- Router -->
			<div class="row">
				<h2>Configuring the Router</h2>
				<hr/>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3 id="router">Router</h3>
					<p>Inspired by <a href="https://expressjs.com/" target="_blank">Express</a>, the Grapevine router logic is pretty simple. When a request comes in, the HTTP verb and the path info are used to determine which routes in the routing table should be executed and in what order. These routes are then iterated over, passing the <code>IHttpContext</code> from one route to the next - the output from one route becoming the input to the next - until the request is responded to, at which point the remaining routes are not executed (unless you change the default behavior).</p>
					<p>I initially faced some criticism for storing the routing table in an array instead of a tree (even a <a href="https://en.wikipedia.org/wiki/Trie" target="_blank">trie algorithm</a> was suggested). However, the complexity tradeoff between iterating over an array (which tends to be short given most application routing requirements) and walking a tree makes arrays a much better choice. Matching routes to requests can be tricky, because we like to use everything for defining routes. This includes simple strings, regular expressions, wildcards, and path parameters. These can't be stored in a hash because regular expression matches can't be looked up based on a string. You have to iterate somewhere. A hash will only work if you limit routes to static string values. And if that’s the case, why use a router at all?</p>
					<p>Granted, this design allows for adding conflicting routes. This is not a flaw but the intended result of the extremely flexible route matching support allowing regular expressions and wildcards - it's a simple tradeoff. I do, however, make every reasonable attempt to prevent the registration of <i>duplicate</i> routes.</p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>

			<!-- Route -->
			<div class="row">
				<h2>Creating Routes</h2>
				<hr/>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>Route</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>

			<!-- Router -->
			<div class="row">
				<h2>Keeping It Simple: Automatic Route Registration Using Attributes</h2>
				<hr/>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>RestResource</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4">
					<h3>RestRoute</h3>
					<p></p>
					<div class="well well-sm"></div>
				</div>
				<div class="col-md-8">
					<pre class="codeblock">
						<code class="language-csharp">
						</code>
					</pre>
				</div>
			</div>
		</div>

		<!--[if lt IE 9]>
		<script src="/Grapevine/assets/js/jquery-1.12.4.min.js"></script>
		<![endif]-->
		<!--[if gte IE 9]><!-->
		<script src="/Grapevine/assets/js/jquery-2.2.4.min.js"></script>
		<!--<![endif]-->

		<script src="/Grapevine/assets/js/bootstrap.min.js"></script>
		<script src="/Grapevine/assets/js/prism.min.js"></script>

		<!-- [if IE 10]>
		<script src="/Grapevine/assets/js/ie10-viewport-bug-workaround.js"></script>
		<![endif]-->

		<!-- [if IE]>
		<script src="/Grapevine/assets/js/console.js"></script>
		<![endif]-->

		<script src="/Grapevine/assets/js/grapevine.min.js"></script>

		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-35821423-3', 'auto');
			ga('send', 'pageview');
		</script>
	</body>
</html>
